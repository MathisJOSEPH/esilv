<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <script src="./node_modules/web3/dist/web3.min.js"></script>
        <link rel="stylesheet" href="Style_PwC.css" />
        <title>History</title>
    </head>

    <body>

        <header> <!-- header of the page, same on every page of the website-->
            <div>
                <p class="boite_logos">
                    <img hspace="5" src="logo_pwc.png" alt="Logo PwC" class="logo_base">
                    <img hspace="5" src="logo_ethereum.png" alt="Logo ESILV" class="logo_base">
                </p>
            </div>

            <div>
                <h1 class="grand_titre">Ethereum supply chain traceability Proof-of-concept</h1>
            </div>
        </header>

        <nav> <!-- navigation of the page, same on every page of the website-->
            <ul>
                <li><a href="#">Accueil</a></li>
                <li><a href="Creer_acteur.html">Créer un acteur</a></li>
                <li><a href="info_lot.html">Informations sur un lot</a></li>
                <li><a href="Creer_lot.html">Créer un lot</a></li>
                <li><a href="Ajouter_etape.html">Ajouter une étape / certifier</a></li>
            </ul>
        </nav>

        <div id="conteneur_ligne"> <!-- content of the page -->
            <div id="conteneur_colonne"> <!-- FORMULAIRE DE RECHERCHE LOT-->
    			<form>
                    
                    <label for="produit" class="col-lg-2 control-label">Votre Adresse</label>
                    <input id="fromAddress" size="50">
                                        <br>
                    <input type="text" class="question" id="cleflot" required autocomplete="off">
                    <label for="cleflot"><span>Clef du lot</span></label>
                    <br/>
                    <button type="submit" id="button_information" class="button">Afficher informations</button>
                    <button id="button_clear" class="button">Clear</button>
                    <a href="Ajouter_etape.html" class="button">Ajouter une étape</a>
                </form>

                <h2>Informations du Lot</h2>
                <div id="infos"> <!-- INFORMATIONS SUR LE LOT -->
                </div>
    		</div>

    		<div id="conteneur_colonne"> <!-- HISTORIQUE DU LOT -->
    			<h2>Historique du Lot</h2>
    			<div class="container" id="timeline"> <!-- TIMELINE -->
    			</div>
    		</div>
            <br><br>
    	</div>

    	<footer> <!-- footer of the page, same on every page of the website-->
            <br/>
            <p>Copyright PwC France - Tous droits réservés</p>
            <a href="#" class="button">Nous contacter !</a>
            <br/><br/>
        </footer>
		
    	<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js">
    	</script>

         <!-- SCRIPT DE CONNEXION A LA BLOCKCHAIN -->

    	<!-- script to create new divisions in the timeline according to the length of the returned string -->
    
    	       <script type="text/javascript" >
        if (typeof web3 !== 'undefined') 
            {                                               //informations sur le port 8545
                web3 = new Web3(web3.currentProvider);
            } 
            else 
            {
                web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
            }
            web3.eth.defaultAccount = web3.eth.accounts[0];                                  //account en charge des transactions

            document.getElementById('fromAddress').value = web3.eth.defaultAccount;


            var PWCContract = web3.eth.contract(
[
    {
        "constant": true,
        "inputs": [
            {
                "name": "_ref_produit",
                "type": "string"
            }
        ],
        "name": "trouver",
        "outputs": [
            {
                "name": "",
                "type": "string"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [
            {
                "name": "",
                "type": "uint256"
            }
        ],
        "name": "inventaire",
        "outputs": [
            {
                "name": "",
                "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [],
        "name": "kill",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "_ref_produit",
                "type": "string"
            },
            {
                "name": "_ref_lot",
                "type": "string"
            },
            {
                "name": "_lieu",
                "type": "string"
            },
            {
                "name": "_date",
                "type": "string"
            }
        ],
        "name": "Nouveau_Lot",
        "outputs": [
            {
                "name": "",
                "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [],
        "name": "Derniere_Clef",
        "outputs": [
            {
                "name": "",
                "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [],
        "name": "infos_utilisateur",
        "outputs": [
            {
                "name": "",
                "type": "string"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "clef_lot",
                "type": "uint256"
            },
            {
                "name": "_intitule",
                "type": "string"
            },
            {
                "name": "_lieu",
                "type": "string"
            },
            {
                "name": "_date",
                "type": "string"
            },
            {
                "name": "_nouveau_proprietaire",
                "type": "address"
            }
        ],
        "name": "Ajouter_Etape",
        "outputs": [
            {
                "name": "",
                "type": "bool"
            }
        ],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [
            {
                "name": "utilisateur",
                "type": "address"
            }
        ],
        "name": "infos_acteurs",
        "outputs": [
            {
                "name": "",
                "type": "string"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "_adresse",
                "type": "address"
            },
            {
                "name": "_nom",
                "type": "string"
            },
            {
                "name": "_privilege",
                "type": "uint256"
            }
        ],
        "name": "Nouvel_Acteur",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [
            {
                "name": "clef_lot",
                "type": "uint256"
            },
            {
                "name": "utilisateur",
                "type": "address"
            }
        ],
        "name": "utilisateur_est_proprietaire",
        "outputs": [
            {
                "name": "",
                "type": "bool"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [
            {
                "name": "clef_lot",
                "type": "uint256"
            }
        ],
        "name": "info_produit",
        "outputs": [
            {
                "name": "",
                "type": "string"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [
            {
                "name": "clef_lot",
                "type": "uint256"
            }
        ],
        "name": "histoire",
        "outputs": [
            {
                "name": "",
                "type": "string"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [],
        "name": "Auchan",
        "outputs": [
            {
                "name": "",
                "type": "address"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "_adresse",
                "type": "address"
            },
            {
                "name": "_nom",
                "type": "string"
            },
            {
                "name": "_privilege",
                "type": "uint256"
            }
        ],
        "name": "Modifier_Acteur",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "constructor"
    }
]   );

            var PWC = PWCContract.at('0x08d1cc59f410c0181d60d9589287e3167f6905b0');          //adresse du smart contract sur la     blockchain
            console.log(PWC);

            function printInformation($information)
            {
                var $out = "";
                $out = "<br><p>";
                $out += "<h3>Clé du lot sur la blockchain : " + $information.split(";")[0].split(",")[0] + "</h3>";
                $out += "<h3>Type de produit : " + $information.split(";")[0].split(",")[1] + "</h3>";
                $out += "<h3>Référence du lot dans le système de gestion : " + $information.split(";")[0].split(",")[2] + "</h3>";
                $out += "</p><br>";
                document.getElementById("infos").innerHTML = $out;
            }

    	    function clear()
    	    {
                document.getElementById("infos").innerHTML = "";
    	        document.getElementById('timeline').innerHTML = "";
    	    }
	
    	    function makeTimeline($history)
    	    {
    	        //openTimeline();
				var $temp = "<ul>";
    	        for (var $i = 0; $i <= $history.split(";").length - 2; $i++) // une étape en moins à cause du dernier ";"
    	        {
    	            $temp += newTimeStep($history.split(";")[$i].split(","), $i+1);
    	        }

				$temp += "</ul>";
				document.getElementById("timeline").innerHTML = $temp;
    	        //closeTimeline();
    	    }
	
    	    function newTimeStep($infoStep, $numberStep)
    	    {
    	        var $out = "";
    	        //opening timestep
    	        $out = "<li>";
    	        $out += "<div>";
    	        $out += "<span></span>";
	
    	        //filling timestep
    	        $out += "<div class=\"title\">"; 
    	        $out += "step :" + $numberStep; //number of the step
    	        $out += "</div>";
	
    	        $out += "<div class=\"info\">"; 
    	        $out += $infoStep[1]; //location of the step
    	        $out += "</div>";
	
    	        $out += "<div class=\"type\">"; 
    	        $out += $infoStep[3]; //name of the actor of the step
    	        $out += "</div>";

                $out += "<div class=\"title\">"; 
                $out += "Cerfification : " + $infoStep[0]; //certification of the step
                $out += "</div>";
                
    	        
    	        //closing timestep
    	        $out += "</div>";
    	        $out += "<span class=\"number\"><span>";
    	        $out += $infoStep[2]; //date of the step
    	        $out += "</span><span></span></span>";
    	        $out += "</li>";
	
    	        //window.alert($out);
				return $out;
    	        //document.getElementById("timeline").innerHTML += $out;
    	    }
	
    	    $("#button_information").click(function(e)
    	    {
                //printInformation("456,blé,A2675646B18");

    	        //makeTimeline("Gournay en Bray,14/03/2018,Eleveur X;Strasbourg,16/03/2018,Abattoir Bonne Viande;Strabourg,18/03/2018,Sarl Saucisse de Strasbourg;Paris,19/03/2018,Auchan La défense 4 Temps,BIO;");
    	        
    	        // PWC.histoire($("#cleflot").val(), function(error, result)
    	        // {
    	        //     if(!error)
    	        //     {

    	        //         makeTimeline(result);
    	        //         //console.log(result);
    	        //     }
    	        //     else
    	        //     {
    	        //         //console.error(error);
    	        //         //return confirm(console.error(error));
    	        //     }
    	        // });
                e.preventDefault();

                document.getElementById('cleflot').value = $("#cleflot").val();
                PWC.info_produit($("#cleflot").val(),function(error, result){
                    if(!error)
                        {
                            printInformation(result);
                        }
                    else
                        console.error(error);
                });
                PWC.histoire($("#cleflot").val(),function(error, result){
                if(!error)
                    {
                        makeTimeline(result);
                    }
                else
                    console.error(error);
                 });

    	    });

	
    	    $("#button_clear").click(function()
    	    {
    	        clear();
    	    });
    	
        </script>
	</body>
</html>